---
- name: Find home directories with 11 characters containing uppercase letters
  find:
    paths: /home
    file_type: directory
    recurse: no
  register: home_dirs

- name: Debug output of found directories
  debug:
    var: home_dirs.files

- name: Filter directories with exactly 11 characters
  set_fact:
    dirs_with_11_chars: "{{ home_dirs.files | map(attribute='path') | select('match', '/home/.{11}$') | list }}"

- name: Debug output of directories with 11 characters
  debug:
    var: dirs_with_11_chars

- name: Filter directories containing uppercase letters
  set_fact:
    dirs_with_uppercase: "{{ dirs_with_11_chars | select('regex_search', '[A-Z]') | list }}"

- name: Debug output of directories with uppercase letters
  debug:
    var: dirs_with_uppercase

- name: Exclude directories matching /opt/SRV-*
  set_fact:
    dirs_to_delete: "{{ dirs_with_uppercase | select('search', '/opt/SRV-*', invert=True) | list }}"

- name: Debug output of directories to delete
  debug:
    var: dirs_to_delete

- name: Extract usernames from directories to delete
  set_fact:
    users_to_delete: "{{ dirs_to_delete | map('regex_replace', '^/home/', '') | list }}"

- name: Debug output of users to delete
  debug:
    var: users_to_delete

- name: Delete users with specific home directories
  user:
    name: "{{ item }}"
    state: absent
